/* ===================== 追加パッチ ===================== */
const difficultySelect = document.getElementById('difficulty');
let difficulty = 'std';

/* --- 小１用の問題 --- */
function generateG1Question() {
  const op = Math.random() < 0.5 ? '+' : '-';
  let a, b, ans;
  if (op === '+') {
    a = getRandomInt(0, 10);
    b = getRandomInt(0, 10 - a);
    ans = a + b;
  } else {
    a = getRandomInt(0, 10);
    b = getRandomInt(0, a);
    ans = a - b;
  }
  return { question: `${a} ${op} ${b} = ?`, answer: ans, type: 'int' };
}

/* --- generateQuestions をラップ --- */
const _genQs = generateQuestions;
generateQuestions = function (n) {
  questions = [];
  if (difficulty === 'g1') {
    for (let i = 0; i < n; i++) questions.push(generateG1Question());
  } else {
    _genQs(n);           // 元の高度な問題
  }
};

/* --- 三択ボタン UI --- */
const choiceArea = document.getElementById('choice-buttons');
function showChoiceButtons(correct) {
  choiceArea.innerHTML = '';
  choiceArea.classList.remove('hidden');
  const list = [correct];
  while (list.length < 3) {
    const v = getRandomInt(0, 20);
    if (!list.includes(v)) list.push(v);
  }
  list.sort(() => Math.random() - 0.5);
  list.forEach(v => {
    const btn = document.createElement('button');
    btn.textContent = v;
    btn.className =
      'choice-btn bg-white rounded-lg border border-gray-300 shadow text-lg font-bold active:scale-95 transition';
    btn.onclick = () => {
      hiddenInput.value = v;
      checkAnswer();
    };
    choiceArea.appendChild(btn);
  });
}
function hideChoiceButtons() {
  choiceArea.classList.add('hidden');
}

/* --- drawTrainingScreen の差し替え --- */
const _drawTraining = drawTrainingScreen;
drawTrainingScreen = function () {
  if (difficulty === 'g1') {
    drawProgressBar();
    const q = questions[currentQuestionIndex];
    const f = Math.round(BASE_FONT_SIZE_L * scale);
    drawText(q.question, canvas.width / 2, BASE_QUESTION_Y * scale,
      `bold ${f}px "M PLUS Rounded 1c"`, '#333');
    if (choiceArea.classList.contains('hidden')) showChoiceButtons(q.answer);
  } else {
    hideChoiceButtons();
    _drawTraining();
  }
};

/* --- startTraining をフック --- */
const _start = startTraining;
startTraining = async function () {
  difficulty = difficultySelect.value;
  hideChoiceButtons();
  await _start();
  if (difficulty === 'g1') submitButton.classList.add('hidden');
  else submitButton.classList.remove('hidden');
};

/* --- checkAnswer 後に選択肢を隠す --- */
const _check = checkAnswer;
checkAnswer = function () {
  _check();
  if (difficulty === 'g1' &&
      (gameState === 'feedback' || gameState === 'finished')) {
    hideChoiceButtons();
  }
};

/* --- 数値だけを許可 --- */
const _parse = parseAnswerInput;
parseAnswerInput = function (s) {
  if (difficulty === 'g1') return parseInt(s, 10);
  return _parse(s);
};

/* --- イベント --- */
difficultySelect.addEventListener('change', () => {
  difficulty = difficultySelect.value;
});
/* ===================== 追加パッチここまで ===================== */